<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Conhecimento - Mutantes & Malfeitores</title>
    
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=-JMKW0suEJRxKvcAVnFJwAgIVBmtzUzexb1jYRJwpsZa027QelHTF-fEX3sevOT1-6hGm4Dp8x9kUK1UOp7pD44GM3aQrKG1gcw4vqOeHNpwbGZ90pzbZeAOTKFore_n39qBSQylwMs-NDBkpP5NS6M-ux_3P2U4qawiBoXvO7Qd0iCmCImJfqCrtAxqPNXZC7GabaS0_WTuthFzk3IalTKXuTrRuVGDcMkGXfyIDKGV7bq8YtXjLD-7ObkUKdrTKtQp3Dakmg44YRBFNHb6M3yxaYAuFvdBI6lmgi-uIVRp4KNFYbKIbCbl0ExqvN2_lWpJK8qldNT5pnB4O7vHfQ4-9DNGlpAB5oaf2yQQFNF9CdtaudHGb3lfZNTNMf0aQPl0bSZDGoL8DNGygkaBGJhcjQF364aVnOidfxmpYr2MTrvJsco1CDQ_xHR2HMS9s1yrFbLwd-iBxBE5P4kiac73oJMsRa331fbq-zBDJNLm-mFcPgTXXJnbOMEPI6i7MQl6EGZbKSjyVSL_k189GHnjfPXOHUeO3ZaKZ7OFtwY9uYODjGRUeakUVEZmjorOC9Ir0yG_h5PDZ1g9mfsnOELvXG9PrTAOH2_yYmtd6tuYZKBIAs51huVJtVc8gBzW9f8GIBRYx0rkEwYVo7RpMXRXo-RdcGUpB5KcxH297Uk04ieFHzgQMOYt76iigksQKkcpbbzDFc2U6-lFMe16_sdbmw6Cpuq_T5huyUavQzJS_flY-z2BkmkHkIiFJIcXFYHeuSA4SfJuASazl4tvQxIUT264nVtFkBo0hfStGzYbamqJAzPE0-29gocoaKtzynndyE0G_QlXQ6uQwNx4ZwKU3jGG7U4BKkXq4bK8qgFTxmQULaw7fAe-YwGEohPe7_QXU7cyFCWnc5QtQv8OxEl0bRDJcfhkmD_w-E6iEaNcfzZ4WPxAeW9zGUdH7LVm6z73j892VsyfKvOUGFgxEyXiGEMnpIUczxnavIPtOdfMBNTC3DgRcfsTnpxPFuXMeCrXZ9aPDoUPI8RYcfq8L1CAT1jS-3qbtHhqtckUNQuGGJPrw7_yssjUmoJ-rpupNXNQv27WmiH7W8psnn9zc8Kevpww1hdxXK4cEJzG_KfCgSJlh-G8v_PuaI8n8R1OUQzD_a6WiAfRj-XSq3NKI_dE1qzCXPmDnLne2sFx1MJk6Jwo0LYCgcaxSYgEv0l9c-a84pk4IMPLiHtsDOjER1-nnLsYtbiEoT5lcqy4TEul70aDQY85_aTqB_s3MVMfUnnpcKJY-3okHCRMaiWFFvXezXYSM7r-cDbNGLyKWTMDZHU66aQHvlveP_MRBqD6kuZdTQ18lSG07zFg_fFHX158O28X4imKQZf7TaPjy_X4-lmfWgNKj_qwH8kP-avH4hGW9kqIiGmzkOluvdS845y8baA-fAR4rxJyHmVImNLEITBpL9t58h8An0BcnABLmWrDuy7wz0SGf_XVMOO4SF7dJ0cslBmeK5YjEmMyaodlysv_qrM9iwdIungmdnvPz25nvz2EGhnx4NuBf7PhX7PXSyotnS4iKzNbFbMjKuBgJhV72N0-AIILXIoCCH_AVW-9uZHPMMdsuYb4fXBO6Z-Xs0IY5DuGz8yiOh6inV2sxUe5aUhTrjB9xID1pVsVWlY1txUiG0nY7bIb6ufHuFmIcYmuwf2NfTEBoJS0Wdz13vDPaXXk8CA9ujHO4XQA9exTcPik4TGqB8xE0Xi95Sp7rAO_kRdhM84IBTyjsGTF2EjgpXFINzGqt5tu1q5rzgSHJl01z37xgouijU9ANvr1lI7rcNCB0UlsQT2stEWdp7NFTsG8IMq58loOWNVzPvMudbDXtUX0ipA4FRY7uB7XIjYE_PwaFtIF_IfJ_JDimZhVy_LsExAZCd4gZkF569Ud1u-ye0Ds7kvwu4gW8pAU8novdKgulR0CzzjBb4U0klA187qIrLaIhpxqLRjsqv8rI8hh-PC6a-mKNgO8i_hGP6X-L_35M-MsJSreiLO6omyCkil_5iqo2zjs_L84rzRXIPTFxrfoREaQ_XIUpRsZWA9AIpX1qTOA9YUo1aqIZ9IWIf4q9fgUs2DC-rlHnMLKiAGi5rj2-YDt4js9mvzgs5Wig9spfd_7mC42AyjeWmkeay85r7NKFLfmEYwez3Jf8Dqtyv3cOHpm5HHD1iuoY1G0P3U4C4rIhTOsPFXcO5ndXbFbvHR4Iablzv1qLkZPKNA-Jk203LdNcBdblFmsFSETj2_BX7f1ir6MI4mZ-3NqjSBeQm32zkmJuk3E" charset="UTF-8"></script><script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos CSS do seu arquivo original -->
    <style>
        :root {
            --bg-primary: #f8fafc; /* slate-50 */
            --bg-secondary: #ffffff;
            --bg-accent: #eef2ff; /* indigo-50 */
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --border-color: #e2e8f0; /* slate-200 */
            --brand-primary: #4f46e5; /* indigo-600 */
            --brand-secondary: #f59e0b; /* amber-500 */
        }

        .dark {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-accent: #312e81; /* indigo-900 */
            --text-primary: #e2e8f0; /* slate-200 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .nav-bg {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .dark .nav-bg {
            background-color: rgba(15, 23, 42, 0.8);
        }

        .chart-container {
            position: relative;
            margin: auto;
            height: 350px;
            max-height: 400px;
            width: 100%;
            max-width: 400px;
        }

        .fade-in-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .gemini-answer p {
            margin-bottom: 0.75rem;
        }

        .gemini-answer ul {
            list-style-position: inside;
            list-style-type: disc;
            margin-left: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .gemini-answer strong {
            color: var(--text-primary);
        }
    </style>
</head>

<body class="antialiased">
    <!-- Header com nova navega√ß√£o -->
    <header class="nav-bg sticky top-0 z-50 border-b border-[var(--border-color)]">
        <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold text-[var(--brand-primary)]">Base MM</h1>
            
            <div class="flex items-center gap-4">
                <!-- NOVO: Link para Sistema de Ficha -->
                <a href="ficha-personagem.html" 
                   class="hidden sm:flex items-center gap-2 px-4 py-2 bg-[var(--brand-primary)] text-white rounded-lg font-semibold hover:opacity-90 transition-all duration-300 transform hover:scale-105">
                    ‚ö° Sistema de Ficha
                </a>
                
                <!-- Vers√£o mobile do bot√£o -->
                <a href="ficha-personagem.html" 
                   class="sm:hidden p-2 rounded-full hover:bg-[var(--bg-accent)] transition-colors" 
                   title="Sistema de Ficha">
                    ‚ö°
                </a>
                
                <!-- Toggle de tema -->
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-[var(--bg-accent)] transition-colors">
                    <span id="theme-icon">üåô</span>
                </button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 sm:p-6 md:p-8">
        <!-- Se√ß√£o de introdu√ß√£o -->
        <section id="inicio" class="text-center my-12 fade-in-section">
            <h2 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[var(--brand-primary)] to-[var(--brand-secondary)] mb-4">
                Base de Conhecimento Interativa
            </h2>
            <p class="max-w-3xl mx-auto text-lg text-[var(--text-secondary)]">
                Sua central de regras para Mutantes & Malfeitores. Ajuste o N√≠vel de Poder da campanha e tire suas d√∫vidas com o Assistente de Regras.
            </p>
        </section>

        <!-- Seletor de N√≠vel de Poder -->
        <div class="card p-6 rounded-xl shadow-lg fade-in-section mb-8 text-center" data-search-keywords="np n√≠vel de poder campanha pontos">
            <h3 class="text-xl font-bold text-[var(--brand-primary)] mb-4">Ajustar N√≠vel de Poder (NP) da Campanha</h3>
            <div class="flex items-center justify-center gap-4 max-w-xs mx-auto">
                <label for="np-selector" class="font-semibold text-lg text-[var(--text-secondary)]">NP:</label>
                <input type="number" id="np-selector" value="10" min="1" max="30" 
                       class="w-40 p-2 text-xl text-center font-bold border-2 border-[var(--border-color)] rounded-md bg-[var(--bg-primary)] focus:ring-2 focus:ring-[var(--brand-primary)] focus:outline-none">
            </div>
        </div>

        <!-- Barra de pesquisa -->
        <div class="sticky top-[61px] z-40 p-4 bg-[var(--bg-primary)] -mx-4 sm:-mx-6 md:-mx-8 mb-8 fade-in-section">
            <div class="container mx-auto">
                <input type="text" id="search-input" 
                       placeholder="üîç Pesquisar t√≥picos (ex: ataque, per√≠cias, ponto de her√≥i)..." 
                       class="w-full p-3 text-lg border-2 border-[var(--border-color)] rounded-lg bg-[var(--bg-secondary)] focus:ring-2 focus:ring-[var(--brand-primary)] focus:outline-none transition-shadow">
            </div>
        </div>

        <!-- Grid de conte√∫do -->
        <div id="content-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            
            <!-- Assistente de Regras -->
            <div class="card p-6 rounded-xl shadow-lg fade-in-section md:col-span-2 lg:col-span-3" data-search-keywords="d√∫vida regras assistente ia gemini pergunta mestre jogo cache banco de dados">
                <h3 class="text-2xl font-bold text-[var(--brand-primary)] mb-4 text-center">ü§ñ Assistente de Regras</h3>
                <p class="text-center text-[var(--text-secondary)] mb-6 max-w-2xl mx-auto">
                    Tem uma d√∫vida espec√≠fica? Pergunte ao Mestre Digital! As respostas s√£o salvas para acesso instant√¢neo no futuro.
                </p>
                
                <div class="flex flex-col gap-4 max-w-2xl mx-auto">
                    <textarea id="rule-question" 
                              placeholder="Sua pergunta sobre as regras... (ex: Como funciona a a√ß√£o de agarrar?)" 
                              class="w-full p-3 border border-[var(--border-color)] rounded-md focus:ring-2 focus:ring-[var(--brand-primary)] focus:outline-none bg-[var(--bg-primary)]" 
                              style="min-height: 80px;"></textarea>
                    
                    <button id="rule-btn" 
                            class="bg-[var(--brand-primary)] text-white font-bold py-3 px-6 rounded-md hover:opacity-90 transition-opacity duration-300 disabled:opacity-50">
                        Perguntar ao Mestre
                    </button>
                </div>
                
                <div id="rule-result" class="mt-8"></div>
            </div>

            <!-- Gerador de Conceitos -->
            <div class="card p-6 rounded-xl shadow-lg fade-in-section md:col-span-2 lg:col-span-3" data-search-keywords="gemini ia gerador conceito her√≥i cria√ß√£o personagem ideia inspira√ß√£o">
                <h3 class="text-2xl font-bold text-[var(--brand-primary)] mb-4 text-center">‚ú® Gerador de Conceitos de Her√≥i</h3>
                <p class="text-center text-[var(--text-secondary)] mb-6 max-w-2xl mx-auto">
                    Sem ideias? Digite uma palavra-chave (ex: sombra, tecnologia, rocha) e deixe a IA criar her√≥is para voc√™!
                </p>
                
                <div class="flex flex-col sm:flex-row gap-4 max-w-lg mx-auto">
                    <input type="text" id="gemini-prompt" 
                           placeholder="Digite sua palavra-chave..." 
                           class="flex-grow p-3 border border-[var(--border-color)] rounded-md focus:ring-2 focus:ring-[var(--brand-primary)] focus:outline-none bg-[var(--bg-primary)]">
                    
                    <button id="gemini-btn" 
                            class="bg-[var(--brand-primary)] text-white font-bold py-3 px-6 rounded-md hover:opacity-90 transition-opacity duration-300 disabled:opacity-50">
                        Gerar Ideias
                    </button>
                </div>
                
                <div id="gemini-result" class="mt-8 space-y-4"></div>
            </div>

            <!-- NOVO: Se√ß√£o Sistema de Ficha (Destaque) -->
            <div class="card p-6 rounded-xl shadow-lg fade-in-section md:col-span-2 lg:col-span-3" data-search-keywords="ficha personagem criador her√≥i criar salvar carregar pontos de poder habilidades defesas per√≠cias vantagens poderes">
                <h3 class="text-2xl font-bold text-[var(--brand-primary)] mb-4 text-center">‚ö° Sistema de Ficha</h3>
                <p class="text-center text-[var(--text-secondary)] mb-6 max-w-2xl mx-auto">
                    Crie e gerencie fichas completas de personagens com c√°lculos autom√°ticos de Pontos de Poder, limites de troca e valida√ß√µes baseadas no NP.
                </p>
                
                <div class="text-center">
                    <a href="ficha-personagem.html" 
                       class="inline-block bg-[var(--brand-primary)] text-white font-bold py-3 px-8 rounded-md hover:opacity-90 transition-all duration-300 transform hover:scale-105 shadow-lg">
                        üöÄ Criar Nova Ficha
                    </a>
                </div>
                
                <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-[var(--bg-accent)] rounded-lg">
                        <div class="text-2xl mb-2">‚öôÔ∏è</div>
                        <div class="font-semibold text-sm">C√°lculos Autom√°ticos</div>
                        <div class="text-xs text-[var(--text-secondary)]">PP, limites e custos</div>
                    </div>
                    <div class="p-3 bg-[var(--bg-accent)] rounded-lg">
                        <div class="text-2xl mb-2">üíæ</div>
                        <div class="font-semibold text-sm">Salvamento Local</div>
                        <div class="text-xs text-[var(--text-secondary)]">Dados seguros no navegador</div>
                    </div>
                    <div class="p-3 bg-[var(--bg-accent)] rounded-lg">
                        <div class="text-2xl mb-2">üéØ</div>
                        <div class="font-semibold text-sm">Valida√ß√£o Inteligente</div>
                        <div class="text-xs text-[var(--text-secondary)]">Baseada no NP da campanha</div>
                    </div>
                </div>
            </div>

            <!-- Resto do conte√∫do do seu arquivo original continua aqui... -->
            
            <!-- O B√°sico: D20 & NP -->
            <div class="card p-6 rounded-xl shadow-lg fade-in-section" data-search-keywords="b√°sico d20 teste np n√≠vel de poder cd classe de dificuldade">
                <h3 class="text-2xl font-bold text-[var(--brand-primary)] mb-4">O B√°sico: D20 & NP</h3>
                <ul class="mt-4 space-y-2">
                    <li><strong>Teste Principal:</strong> Role 1d20 + B√¥nus para superar uma Classe de Dificuldade (CD).</li>
                    <li><strong>N√≠vel de Poder (NP):</strong> Define o total de Pontos de Poder (<strong id="pp-total" class="text-[var(--brand-secondary)]">150</strong> para NP <strong id="np-display-basic" class="text-[var(--brand-secondary)]">10</strong>) e limita seus b√¥nus.</li>
                </ul>
            </div>

            <!-- üí• Troca de Ataque & Efeito -->
            <div class="card p-6 rounded-xl shadow-lg fade-in-section" data-search-keywords="ataque b√¥nus de ataque efeito dano acerto troca compensa√ß√£o">
                <h3 class="text-xl font-bold text-[var(--brand-primary)] mb-2">üí• Troca de Ataque & Efeito</h3>
                <p class="text-[var(--text-secondary)]">
                    A soma do seu B√¥nus de Ataque + Gradua√ß√£o do Efeito (dano, afli√ß√£o, etc.) n√£o pode exceder <strong id="tradeoff-limit" class="text-[var(--brand-secondary)]">20</strong> (o dobro do NP).
                </p>
            </div>

            <!-- Chart de distribui√ß√£o -->
            <div class="card p-6 rounded-xl shadow-lg fade-in-section">
                <h3 id="chart-title" class="text-xl font-bold text-center text-[var(--brand-primary)] mb-4">Sugest√£o de Distribui√ß√£o (NP 10)</h3>
                <div class="chart-container">
                    <canvas id="pp-chart"></canvas>
                </div>
            </div>

            <!-- Outras se√ß√µes existem no seu c√≥digo original... -->
            <!-- Por quest√µes de espa√ßo, vou incluir apenas algumas principais -->

            <!-- Simulador de Teste -->
            <div class="card p-6 rounded-xl shadow-lg fade-in-section" data-search-keywords="simulador teste rolar dado graus de sucesso falha cr√≠tica">
                <h3 class="text-2xl font-bold text-[var(--brand-primary)] mb-4">üé≤ Simulador de Teste</h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="modifier" class="block font-semibold text-[var(--text-secondary)] text-sm mb-1">Seu B√¥nus Total:</label>
                        <input type="number" id="modifier" value="10" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--bg-primary)]">
                    </div>
                    
                    <div>
                        <label for="dc" class="block font-semibold text-[var(--text-secondary)] text-sm mb-1">Dificuldade (CD):</label>
                        <input type="number" id="dc" value="20" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--bg-primary)]">
                    </div>
                    
                    <button id="roll-btn" class="w-full bg-[var(--brand-primary)] text-white font-bold py-2 rounded-md hover:opacity-90 transition-opacity">
                        Rolar o d20! üé≤
                    </button>
                </div>
                
                <div id="roll-result" class="mt-4 bg-[var(--bg-primary)] p-4 rounded-md min-h-[80px] text-center text-sm">
                    <p>Os resultados aparecer√£o aqui.</p>
                </div>
            </div>

            <!-- Pontos de Her√≥i -->
            <div class="card p-6 rounded-xl shadow-lg fade-in-section" data-search-keywords="pontos de her√≥i ph sorte complica√ß√µes rerrolar melhorar teste recuperar inspira√ß√£o fa√ßanha editar cena">
                <h3 class="text-2xl font-bold text-[var(--brand-primary)] mb-4">üåü Pontos de Her√≥i</h3>
                <p class="text-[var(--text-secondary)]">Sua sorte de her√≥i, ganhos por meio de Complica√ß√µes. Podem ser usados para:</p>
                
                <ul class="mt-4 space-y-2 text-sm list-disc list-inside">
                    <li>Rerrolar um teste</li>
                    <li>Adicionar +5 a um teste</li>
                    <li>Recuperar-se de condi√ß√µes</li>
                    <li>Obter uma dica do Mestre</li>
                    <li>Criar uma Fa√ßanha de Poder tempor√°ria</li>
                    <li>Editar a cena com um pequeno detalhe</li>
                </ul>
            </div>

        </div>
    </main>

    <footer class="text-center p-6 mt-16 border-t border-[var(--border-color)]">
        <p class="text-[var(--text-secondary)]">&copy; 2025 Base de Conhecimento MM.</p>
    </footer>

    <!-- Todo o JavaScript do seu arquivo original -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- ELEMENT REFERENCES ---
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const htmlEl = document.documentElement;
            const searchInput = document.getElementById('search-input');
            const contentGrid = document.getElementById('content-grid');
            const allCards = Array.from(contentGrid.children);
            const rollBtn = document.getElementById('roll-btn');
            const rollResultEl = document.getElementById('roll-result');
            const geminiBtn = document.getElementById('gemini-btn');
            const geminiPromptInput = document.getElementById('gemini-prompt');
            const geminiResultContainer = document.getElementById('gemini-result');
            const ruleBtn = document.getElementById('rule-btn');
            const ruleQuestionInput = document.getElementById('rule-question');
            const ruleResultContainer = document.getElementById('rule-result');
            const ctx = document.getElementById('pp-chart').getContext('2d');

            // NP-related elements
            const npSelector = document.getElementById('np-selector');
            const ppTotalEl = document.getElementById('pp-total');
            const npDisplayBasicEl = document.getElementById('np-display-basic');
            const tradeoffLimitEl = document.getElementById('tradeoff-limit');
            const chartTitleEl = document.getElementById('chart-title');

            // --- STATE INITIALIZATION ---
            let ruleCache = JSON.parse(localStorage.getItem('mmrulecache')) || {};
            let ppChart;

            const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark mode
            htmlEl.classList.toggle('dark', savedTheme === 'dark');
            themeIcon.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

            // --- EVENT LISTENERS ---
            themeToggle.addEventListener('click', () => {
                htmlEl.classList.toggle('dark');
                const isDark = htmlEl.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                themeIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                updateChartColors();
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, {
                threshold: 0.1,
            });

            document.querySelectorAll('.fade-in-section').forEach((section) => {
                observer.observe(section);
            });

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                allCards.forEach((card) => {
                    const keywords = card.dataset.searchKeywords || '';
                    card.style.display = keywords.includes(searchTerm) ? '' : 'none';
                });
            });

            rollBtn.addEventListener('click', () => {
                const modifier = parseInt(document.getElementById('modifier').value) || 0;
                const dc = parseInt(document.getElementById('dc').value) || 0;
                const roll = Math.floor(Math.random() * 20) + 1;
                const total = roll + modifier;

                let resultText = `<p class="font-bold text-lg">Rolagem: ${roll} + ${modifier} = <span class="text-[var(--brand-primary)]">${total}</span></p>`;

                let successLevel;
                if (roll === 1) {
                    successLevel = '<p class="text-red-500 font-bold">FALHA CR√çTICA!</p>';
                } else if (roll === 20) {
                    successLevel = '<p class="text-green-500 font-bold">SUCESSO CR√çTICO!</p>';
                } else if (total >= dc) {
                    successLevel = '<p class="text-green-500 font-bold">SUCESSO!</p>';
                } else {
                    successLevel = '<p class="text-red-500 font-bold">FALHA!</p>';
                }

                rollResultEl.innerHTML = resultText + successLevel;
            });

            npSelector.addEventListener('input', () => {
                const newNP = parseInt(npSelector.value, 10) || 1;
                updateForNP(newNP);
            });

            // --- NP-RELATED FUNCTIONS ---
            function updateForNP(np) {
                if (np < 1) np = 1;
                
                const totalPoints = np * 15;
                const tradeoffLimit = np * 2;
                
                ppTotalEl.textContent = totalPoints;
                npDisplayBasicEl.textContent = np;
                tradeoffLimitEl.textContent = tradeoffLimit;
                chartTitleEl.textContent = `Sugest√£o de Distribui√ß√£o (NP ${np})`;
                
                if (ppChart) {
                    const dist = {
                        powers: Math.round(totalPoints * 0.47),
                        abilities: Math.round(totalPoints * 0.26),
                        defenses: Math.round(totalPoints * 0.13),
                        advantages: Math.round(totalPoints * 0.07),
                        skills: Math.round(totalPoints * 0.07),
                    };
                    
                    const currentSum = Object.values(dist).reduce((a, b) => a + b, 0);
                    dist.powers += totalPoints - currentSum;
                    
                    ppChart.data.datasets[0].data = Object.values(dist);
                    ppChart.update();
                }
            }

            // --- CHART FUNCTIONS ---
            function createChart() {
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#e2e8f0' : '#1e293b';
                
                if (ppChart) ppChart.destroy();
                
                ppChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Poderes', 'Habilidades', 'Defesas', 'Vantagens', 'Per√≠cias'],
                        datasets: [{
                            data: [70, 39, 20, 11, 10],
                            backgroundColor: ['#4f46e5', '#ef4444', '#22c55e', '#f59e0b', '#3b82f6'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: textColor
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.label}: ${ctx.parsed} Pontos (Aprox.)`
                                }
                            }
                        }
                    }
                });
            }

            function updateChartColors() {
                if (ppChart) {
                    const isDark = document.documentElement.classList.contains('dark');
                    ppChart.options.plugins.legend.labels.color = isDark ? '#e2e8f0' : '#1e293b';
                    ppChart.update();
                }
            }

            // --- GEMINI API FEATURES ---
            geminiBtn.addEventListener('click', async () => {
                const keyword = geminiPromptInput.value.trim();
                if (!keyword) {
                    geminiResultContainer.innerHTML = '<p class="text-red-500 text-center">Por favor, digite uma palavra-chave.</p>';
                    return;
                }

                geminiBtn.disabled = true;
                geminiBtn.textContent = 'Gerando...';
                geminiResultContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)]">Aguarde enquanto a IA forja novos her√≥is...</p>';

                const systemPrompt = "Voc√™ √© um mestre experiente de RPG, especializado em Mutantes & Malfeitores. Sua tarefa √© criar conceitos de super-her√≥is criativos e inspiradores para novos jogadores.";
                const userPrompt = `Gere 3 conceitos de her√≥is distintos para Mutants & Malfeitores baseados na palavra-chave "${keyword}". Para cada um, forne√ßa um nome de her√≥i, um conceito de poder principal e uma breve hist√≥ria de origem de uma frase. Certifique-se de que os conceitos sejam variados.`;

                try {
                    const concepts = await callGeminiWithSchema(systemPrompt, userPrompt, {
                        "type": "ARRAY",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "nome": {"type": "STRING"},
                                "conceito": {"type": "STRING"},
                                "historia": {"type": "STRING"}
                            },
                            "required": ["nome", "conceito", "historia"]
                        }
                    });
                    displayConcepts(concepts, geminiResultContainer);
                } catch (error) {
                    console.error('Gemini API Error:', error);
                    geminiResultContainer.innerHTML = '<p class="text-red-500 text-center">Ocorreu um erro ao gerar os conceitos. Tente novamente.</p>';
                } finally {
                    geminiBtn.disabled = false;
                    geminiBtn.textContent = 'Gerar Ideias';
                }
            });

            ruleBtn.addEventListener('click', async () => {
                const question = ruleQuestionInput.value.trim();
                const normalizedQuestion = question.toLowerCase();
                
                if (!question) {
                    ruleResultContainer.innerHTML = '<p class="text-red-500 text-center">Por favor, digite sua d√∫vida sobre as regras.</p>';
                    return;
                }

                ruleBtn.disabled = true;
                ruleBtn.textContent = 'Pesquisando...';

                if (ruleCache[normalizedQuestion]) {
                    ruleResultContainer.innerHTML = '<p class="text-center text-green-500">Resposta encontrada no banco de dados local!</p>';
                    setTimeout(() => {
                        displayFormattedAnswer(ruleCache[normalizedQuestion], ruleResultContainer);
                        ruleBtn.disabled = false;
                        ruleBtn.textContent = 'Perguntar ao Mestre';
                    }, 500);
                    return;
                }

                ruleResultContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)]">Consultando os manuais... Por favor, aguarde.</p>';

                const systemPrompt = "Voc√™ √© um Mestre de Jogo especialista em Mutantes & Malfeitores 3¬™ Edi√ß√£o. Responda a seguinte d√∫vida sobre as regras do jogo de forma clara e concisa, como se estivesse explicando para um jogador durante uma partida. Use a busca para encontrar as regras mais precisas. Sua resposta deve ser direta e f√°cil de entender, tente dar um exemplo r√°pido para o jogador entender melhor.";

                try {
                    const answer = await callGroundedGemini(systemPrompt, question);
                    ruleCache[normalizedQuestion] = answer;
                    localStorage.setItem('mmrulecache', JSON.stringify(ruleCache));
                    displayFormattedAnswer(answer, ruleResultContainer);
                } catch (error) {
                    console.error('Grounded Gemini API Error:', error);
                    ruleResultContainer.innerHTML = '<p class="text-red-500 text-center">Ocorreu um erro ao buscar a resposta. Tente novamente.</p>';
                } finally {
                    ruleBtn.disabled = false;
                    ruleBtn.textContent = 'Perguntar ao Mestre';
                }
            });

            // --- API FUNCTIONS ---
            async function callGeminiApi(payload) {
                const apiKey = 'AIzaSyBwOnngmlzPpWIBXMvICZn7xtUd4xM7QXY';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    return text;
                } else {
                    console.warn('API Response was empty or invalid:', result);
                    throw new Error('Resposta da API inv√°lida ou vazia.');
                }
            }

            async function callGeminiWithSchema(systemPrompt, userPrompt, schema) {
                const payload = {
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    contents: [
                        {
                            parts: [{ text: userPrompt }]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                };

                const textResponse = await callGeminiApi(payload);
                return JSON.parse(textResponse);
            }

            async function callGroundedGemini(systemPrompt, userPrompt) {
                const payload = {
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    contents: [
                        {
                            parts: [{ text: userPrompt }]
                        }
                    ],
                    tools: [{
                        google_search: {}
                    }]
                };

                return await callGeminiApi(payload);
            }

            // --- DISPLAY FUNCTIONS ---
            function displayFormattedAnswer(answer, container) {
                const formattedAnswer = answer.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                container.innerHTML = `<div class="card p-4 rounded-lg border-l-4 border-[var(--brand-primary)] gemini-answer">${formattedAnswer}</div>`;
            }

            function displayConcepts(concepts, container) {
                container.innerHTML = '';
                
                if (!concepts || concepts.length === 0) {
                    container.innerHTML = '<p class="text-center text-[var(--text-secondary)]">Nenhuma ideia foi gerada. Tente outra palavra-chave.</p>';
                    return;
                }

                concepts.forEach((concept) => {
                    const card = document.createElement('div');
                    card.className = 'card p-4 rounded-lg border-l-4 border-[var(--brand-primary)]';
                    card.innerHTML = `
                        <h4 class="text-lg font-bold text-[var(--brand-primary)]">${concept.nome}</h4>
                        <p class="text-[var(--text-secondary)] mt-1 text-sm"><strong class="font-semibold text-[var(--text-primary)]">Conceito:</strong> ${concept.conceito}</p>
                        <p class="text-[var(--text-secondary)] mt-2 italic text-sm">${concept.historia}</p>
                    `;
                    container.appendChild(card);
                });
            }

            // --- INITIAL PAGE LOAD CALLS ---
            createChart();
            updateForNP(parseInt(npSelector.value, 10));
        });
    </script>
</body>
</html>